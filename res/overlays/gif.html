<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>GIF</title>
		<script type="application/javascript" src="../jquery.js"></script>
		<script type="application/javascript" src="../client_websocket.js"></script>
		<script type="application/javascript">
			var playing = 0
			function showGif(url, duration) {
				console.log('Show Gif at ' + url)
				var image = new Image()
				image.src = url
				playing++
				image.onload = function() {
					let gif = $('<div style="background-image:url('+url+');"></div>')
					$('body').append(gif)
					window.setTimeout(function(){
						gif.remove()
						playing--
						nextQueue()
					}, duration)
				}
			}
			function showVideo(url, vol) {
				console.log('Show video at ' + url)
				var video = document.createElement('video')
				video.src = url
				playing++
				video.addEventListener('canplaythrough', function() {
					video.volume = vol
					video.play()
				})
				video.addEventListener('error', function(e) {
					console.log('video playback error')
					$(video).remove()
					playing--
					nextQueue()
				})
				video.addEventListener('ended', function() {
					console.log('video playback ended')
					$(video).remove()
					playing--
					nextQueue()
				})
				$('body').append(video)
			}
			function playAudio(url, vol) {
				console.log('Playing audio at ' + url)
				var audio = new Audio(url)
				playing++
				audio.addEventListener('canplaythrough', function() {
					audio.volume = vol
					audio.play()
				})
				audio.addEventListener('error', function(e) {
					console.log('audio playback error')
					audio = null
					playing--
					nextQueue()
				})
				audio.addEventListener('ended', function() {
					console.log('audio playback ended')
					audio = null
					playing--
					nextQueue()
				})
			}

			function urlToObject(str) {
				let obj = {}
				let args = str.split('&')
				for(let i = 0; i < args.length; i++) {
					let a = args[i].split('=', 2)
					if(a.length == 2) {
						obj[a[0]] = a[1]
					} else if(a.length == 1) {
						obj[a[1]] = true
					}
				}
				return obj
			}

			function processMsg(msg) {
				let args = urlToObject(msg)

				if(typeof(args.volume) === 'undefined') args.volume = 1
				else args.volume = parseFloat(args.volume)
				if(args.volume > 1) args.volume = 1
				if(args.volume < 0) args.volume = 0

				if(typeof(args.duration) === 'undefined') args.duration = 3000
				else args.duration = parseInt(args.duration)

				if(typeof(args.gif) === 'string') {
					if(args.gif.match(/^[A-Z]:/i)) args.gif = '/' + args.gif
					args.gif = decodeURIComponent(args.gif)
					args.gif = args.gif.replace(/\\/g, '/')
					showGif(args.gif, args.duration)
				} else if(typeof(args.video) === 'string') {
					if(args.video.match(/^[A-Z]:/i)) args.video = '/' + args.video
					args.video = decodeURIComponent(args.video)
					args.video = args.video.replace(/\\/g, '/')
					showVideo(args.video, args.volume)
				}
				if(typeof(args.audio) === 'string') {
					if(args.audio.match(/^[A-Z]:/i)) args.audio = '/' + args.audio
					args.audio = decodeURIComponent(args.audio)
					args.audio = args.audio.replace(/\\/g, '/')
					playAudio(args.audio, args.volume)
				}
			}

			var queue = []
			function nextQueue()
			{
				if(playing <= 0 && queue.length > 0) {
					playing = 0
					let cmd = queue.shift()
					processMsg(cmd)
				}
			}

			var ws = new WebsocketHelper();
			var visible = false
			$(document).ready(function(){
				ws.on('gif=', function(msg){
					queue.push(msg)
					nextQueue()
				})
				ws.on('video=', function(msg){
					queue.push(msg)
					nextQueue()
				})
				ws.on('audio=', function(msg){
					queue.push(msg)
					nextQueue()
				})
			});
		</script>
		<style type="text/css">
			html, body {
				width: 100%;
				height: 100%;
				padding: 0px;
				margin: 0px;
				text-align: center;
				overflow: hidden;
				position: relative;
			}
			body {
				background-color: rgba(0, 255, 0, 1);
			}
			body > div, body > video {
				width: 100%;
				height: 100%;
				background-color: transparent;
			}
			body > div {
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center center;
			}
		</style>
	</head>
	<body></body>
</html>