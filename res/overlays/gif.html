<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>GIF</title>
		<script type="application/javascript" src="../jquery.js"></script>
		<script type="application/javascript" src="../client_websocket.js"></script>
		<script type="application/javascript">
			function showGif(url, duration) {
				console.log('Show Gif at ' + url)
				var image = new Image()
				image.src = url
				image.onload = function() {
					let gif = $('<div style="background-image:url('+url+');"></div>')
					$('body').append(gif)
					window.setTimeout(function(){
						gif.remove()
					}, duration)
				}
			}
			function showVideo(url, vol) {
				var video = document.createElement('video')
				video.src = url
				video.addEventListener('canplaythrough', function() {
					video.volume = vol
					video.play()
				})
				video.addEventListener('error', function(e) {
					$(video).remove()
				})
				video.addEventListener('ended', function() {
					console.log('playback ended')
					$(video).remove()
				})
				$('body').append(video)
			}
			function playAudio(url, vol) {
				var audio = new Audio(url)
				audio.addEventListener('canplaythrough', function() {
					audio.volume = vol
					audio.play()
				})
			}

			function urlToObject(str) {
				let obj = {}
				let args = str.split('&')
				for(let i = 0; i < args.length; i++) {
					let a = args[i].split('=', 2)
					if(a.length == 2) {
						obj[a[0]] = a[1]
					} else if(a.length == 1) {
						obj[a[1]] = true
					}
				}
				return obj
			}

			var ws = new WebsocketHelper();
			var visible = false
			$(document).ready(function(){
				ws.on('gif=', function(msg){
					let args = urlToObject(msg)
					if(typeof(args.duration) === 'undefined') {
						args.duration = 3000
					} else {
						args.duration = parseInt(args.duration)
					}

					showGif(args.gif, args.duration)
					if(typeof(args.audio) !== 'undefined') {
						ws.emit('audio=', msg)
					}
				})
				ws.on('video=', function(msg){
					let args = urlToObject(msg)
					if(typeof(args.volume) === 'undefined') {
						args.volume = 1
					} else {
						args.volume = parseFloat(args.volume)
					}
					showVideo(args.video, args.volume)
				})
				ws.on('audio=', function(msg){
					let args = urlToObject(msg)
					if(typeof(args.volume) === 'undefined') {
						args.volume = 1
					} else {
						args.volume = parseFloat(args.volume)
					}
					playAudio(args.audio, args.volume)
					if(typeof(args.gif) !== 'undefined') {
						ws.emit('gif=', msg)
					}
				})
			});
		</script>
		<link rel="stylesheet" type="text/css" href="animation.css">
		<style type="text/css">
			html, body {
				width: 100%;
				height: 100%;
				padding: 0px;
				margin: 0px;
				text-align: center;
				overflow: hidden;
				position: relative;
			}
			body {
				background-color: rgba(0, 255, 0, 1);
			}
			body > div, body > video {
				width: 100%;
				height: 100%;
				background-color: transparent;
			}
			body > div {
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center center;
			}
		</style>
	</head>
	<body>

	</body>
</html>